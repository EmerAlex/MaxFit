
@{
    ViewBag.Title = "Home";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="~/Content/css/home.css" rel="stylesheet" />
<form id="UserModal" style=" padding : 10px 30px 10px 30px ">

    <div class="container" style="width: 50% ">
        <div class="form-group" id="divIdentity" style="align-content:center">
            <label class="form-label" style="width: 30%"><b>Identificación</b></label>
            <input type="text" name="Identity" class="form-control" style="width:50%" id="Identity">
        </div>
        <div class="form-group" id="divIdentityType">
            <label class="form-label" style="width: 30%"><b>Tipo de Identificación</b></label>
            <select class="form-select" name="IdentityType" style="width:50%" id="IdentityType">
                <option value="CC">Cédula de Ciudadania</option>
                <option value="TI">Targeta de Identidad</option>
            </select>
        </div>
        <div class="form-group" id="divName">
            <label class="form-label" style="width: 30%"><b>Nombre</b></label>
            <input type="text" name="Name" class="form-control" style="width:50%" id="Name">
        </div>
        <div class="form-group" id="divSubscription">
            <label class="form-label" style="width: 30%"><b>Tipo de Usuario</b></label>
            <select class="form-select" name="Subscription" style="width:50%" id="Subscription">
                <option value="N">Nuevo</option>
                <option value="O">Antiguo</option>
                <option value="Q">Quincena</option>
                <option value="D">Día</option>
            </select>
        </div>
        <div class="align-middle" style="text-align:center">
            <button style="width:100px" type="button" class="btn btn-outline-danger btn-sm" onclick="HideModal()">Cancelar</button>
            <button style="width:100px" type="button" class="btn btn-outline-success btn-sm" id="btnSave" onclick="SaveUser()" disabled>Guardar</button>
            <button style="width:100px" type="button" class="btn btn-outline-success btn-sm" id="btnUpdate" onclick="UpdateUser()" disabled>Actualizar</button>
        </div>
    </div>
</form>
<div class="row m-4">
    <div class="col-sm-12">
        <div class="card">
            <div class="card-header" style="text-align:center">
                <div style="display:inline-block; margin:10px 40px">
                    <div style="margin:10px">
                        <img src="~/Content/icons/user_icon.ico" class="img-fluid" alt="..." width="40" height="40">
                    </div>
                    <div>
                        <button class="btn btn-outline-success btn-sm" onclick="ShowModal(0)">Nuevo Usuario</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="SearchExpired()">Usuarios Vencidos</button>
                        <a class="btn btn-outline-info btn-sm" href="@Url.Action("Record","MaxFit")">Historial Usuarios</a>
                    </div>
                </div>
                <div style="display:inline-block ; margin:10px 40px">
                    <div style="margin:10px">
                        <img src="~/Content/icons/buy_icon.ico" class="img-fluid" alt="..." width="40" height="40">
                    </div>
                    <div>
                        <button class="btn btn-outline-success btn-sm" onclick="SellWather()">Vender Agua</button>
                        <a class="btn btn-outline-info btn-sm" href="@Url.Action("Drink","MaxFit")">Historial Bebidas</a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <table id="tbuser" class="table">
                    <thead>
                        <tr>
                            <th>Nro Documento</th>
                            <th>Nombre Completo</th>
                            <th>Fecha de Incripción</th>
                            <th>Fecha de Vencimiento</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</div>



@section scripts{
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        var table_user;
        $(document).ready(function () {
            $("#UserModal").hide();
            table_user = $('#tbuser').DataTable({
                "ajax": {
                    "url": "@Url.Action("FindAllUsers","User")",
                    "type": "GET",
                    "datatype": "json"
                },
                "columns": [
                    { "data": "Identity"},
                    { "data": "Name" },
                    { "data": "DateInscription" },
                    { "data": "DateExpired" },
                    { "data": "Identity", "render": function (data) {

                        return "<button style='margin: 5px' class='btn btn-outline-primary btn-sm' type='button' onclick='ShowModal(" + data + ")'>Renovar</button>" +
                                "<button style='margin: 5px' class='btn btn-outline-danger btn-sm' type='button' onclick='DeleteUser(" + data + ")'>Eliminar</button>"
                        }
                    }
                ]
                });
        });
        function HideModal() {
            $("#UserModal").hide();
        }
        function ShowModal($Document) {
            if($Document == 0){
                $("#Identity").prop('disabled',false);
                $("#Identity").val('');
                $("#divIdentity").show();
                $("#divIdentityType").show();
                $("#Name").val('');
                $("#divName").show();
                $("#divSubscription").show();
                $("#btnUpdate").prop('disabled',true);
                $("#btnUpdate").hide();
                $("#btnSave").prop('disabled',false);
                $("#btnSave").show();
                $("#UserModal").show();
            }else{
                $("#Identity").prop('disabled',true);
                $("#Identity").val($Document);
                $("#divIdentityType").hide();
                $("#divName").hide();
                $("#divSubscription").show();
                $("#btnSave").prop('disabled',true);
                $("#btnSave").hide();
                $("#btnUpdate").prop('disabled',false);
                $("#btnUpdate").show();
                $("#UserModal").show();
            }
        }
        function SaveUser() {
            var $data = {
                userSubmit:{
                    Identity: $("#Identity").val(),
                    IdentityType: $("#IdentityType").val(),
                    Name: $("#Name").val(),
                    Subscription: $("#Subscription").val()
                }
            }
            jQuery.ajax({
                url: "@Url.Action("SaveUser","User")",
                type: "POST",
                data: JSON.stringify($data),
                datatype: "json",
                contentType: "application/json; charset-utf-8",
                success: function (data) {
                    if (data.result) {
                        table_user.ajax.reload();
                        $("#UserModal").hide();
                    } else {
                        Swal.fire({
                            title: 'Error',
                            text: 'No se pudo guardar el usuario de forma correcta',
                            icon: 'error'
                        });
                    }
                }
                })
        }

        function UpdateUser() {
            var $data = {
                userSubmit:{

                    Identity: $("#Identity").val(),
                    Subscription: $("#Subscription").val()
                }
            }
            jQuery.ajax({
                url: "@Url.Action("UpdateUser","User")",
                type: "POST",
                data: JSON.stringify($data),
                datatype: "json",
                contentType: "application/json; charset-utf-8",
                success: function (data) {
                    if (data.result) {
                        table_user.ajax.reload();
                        $("#UserModal").hide();
                    } else {
                        Swal.fire({
                            title: 'Error',
                            text: 'No se pudo actualizar el usuario de forma correcta',
                            icon: 'error'
                        });
                    }
                }
                })
        }
        function DeleteUser($identity) {
            Swal.fire({
                title: 'Desea Eliminar el Usuario',
                icon: 'question',
                showCancelButton: true,
                cancelButtonText:'Cancelar',
                confirmButtonText: 'Confirmar'
            }).then((response) => {
                var $data = {
                 userSubmit:{
                        Identity: $identity
                 }
               }
            jQuery.ajax({
                url: "@Url.Action("DeleteUser", "User")",
                type: "POST",
                data: JSON.stringify($data),
                datatype: "json",
                contentType: "application/json; charset-utf-8",
                success: function (data) {
                    if (data.result) {
                        table_user.ajax.reload();
                    } else {
                        Swal.fire({
                            title: 'Error',
                            text: 'No se pudo eliminar el usuario de forma correcta',
                            icon: 'error'
                        });
                    }
                }
            })

            })

        }
        function SearchExpired() {
            jQuery.ajax({
                url: "@Url.Action("FindAllUsersExpired", "User")",
                type: "GET",
                datatype: "json",
                contentType: "application/json; charset-utf-8",
                success: function (data) {
                    table_user.clear();
                    table_user.rows.add(data.data);
                    table_user.draw();
                }
            })
        }
        function SellWather() {
            Swal.fire({
                title: 'Confirmar Venta',
                icon: 'question',
                showCancelButton: true,
                cancelButtonText: 'Cancelar',
                confirmButtonText: 'Vender'
            }).then((response) => {
                jQuery.ajax({
                url: "@Url.Action("SaveDrink","Drink")",
                type: "POST",
                datatype: "json",
                contentType: "application/json; charset-utf-8",
                success: function (data) {
                    if (!data.result) {
                        Swal.fire({
                            title: 'Error',
                            text: 'No se pudo registrar la venta de forma correcta',
                            icon: 'error'
                        });
                    }
                }
                })
            })
        }
    </script>
}


